(()=>{let o="https://jbjtads.sso66s.cc",m="",h=(window.location.host.includes("jbagency668")?m="金貝飞投":window.location.host.includes("tsyl6666")&&(m="天胜娱乐"),["001001001001","001001001002"]);document.addEventListener("click",function(e){let t=setTimeout(()=>{clearTimeout(t),t=null;var e=document.querySelector(".navTab-tab .selected")?.getAttribute("tabid");h.includes(e)?$("#buttonContainer").css("display","flex"):$("#buttonContainer").hide()},100)},!0);var e;(e=document.createElement("link")).rel="stylesheet",e.href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css",document.head.appendChild(e),(e=document.createElement("script")).src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js",e.onload=()=>{{let e=document.createElement("style"),t=(e.textContent=`
                .my-popup-mask {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999;
                }
                .my-popup-content {
                    background: white; padding: 20px; border-radius: 8px; width: 80%; max-height: 90%;
                    display: flex; 
                    flex-direction: column;
                }
                .my-popup-header {
                    position: relative;
                    text-align: left;
                }
                .my-popup-header input {
                    padding: 2px 5px; width: 600px;
                }
                .my-popup-body {
                    flex: 1; overflow: auto;
                }
                .my-popup-close {
                    position: absolute; top: -16px; right: -16px; font-size: 32px; padding: 5px 10px; cursor: pointer;
                }
                .tabulator{
                    background-color: #FFFFFF !important;
                }
            `,document.head.appendChild(e),document.createElement("div")),o=(t.className="my-popup-mask",t.innerHTML=`
                <div class="my-popup-content">
                    <div class="my-popup-header">
                        <input type="text" id="tab-search-input" placeholder="请输入 ucode，多个用英文逗号分隔" />
                        <button id="tab-search-btn">查询</button>
                        <div class="my-popup-close">×</div>
                    </div>
                    <div class="my-popup-body">
                        <div id="tabulator-table"></div>
                    </div>
                </div>
            `,document.body.appendChild(t),t.querySelector(".my-popup-close").onclick=()=>t.style.display="none",new Tabulator("#tabulator-table",{height:"300px",layout:"fitColumns",columns:[{title:"用户昵称",field:"uname",width:"100"},{title:"用户id",field:"ucode",width:"100"},{title:"同设备个数",field:"devicesNum",width:"100"},{title:"同设备明细",field:"devicesStr"}],data:[]})),a=document.getElementById("tab-search-btn"),n=document.getElementById("tab-search-input");a.onclick=function(){(async()=>{var e=document.getElementById("tab-search-input").value.trim().replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);if(!e?.length)return;var t,a=[];for(t of e){var n=await l(t);a.push({uname:n[0]?.uname||"",ucode:t,devices:n})}o.setData(a.map(e=>({...e,ucode:e.ucode,uname:e.uname||"",devicesNum:e.devices?.length,devicesStr:e.devices.map(e=>`${e.uname||""}(${e.ucode})`).join("、")})))})()},n.addEventListener("keydown",function(e){"Enter"===e.key&&a.click()}),window.showModel=()=>{t.style.display="flex"}}},document.body.appendChild(e);let r=async(e,t={})=>{try{var a=new URLSearchParams(t).toString(),n=await(await fetch(""+o+e+"?"+a)).json();return 0===n.code?n:{}}catch(e){return{}}},f=async(t,a)=>{try{let e=await fetch(""+o+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return 0===(e=await e?.json()).code?e?.data||!0:!1}catch(e){return!1}},g=(e,t="JBJT",a="0000000000000000")=>{t=CryptoJS.enc.Utf8.parse(t),a=CryptoJS.enc.Utf8.parse(a);return CryptoJS.AES.encrypt(e,t,{iv:a,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString()},d=(e,t="JBJT",a="0000000000000000")=>{t=CryptoJS.enc.Utf8.parse(t),a=CryptoJS.enc.Utf8.parse(a);return CryptoJS.AES.decrypt(e,t,{iv:a,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)};(()=>{var e=$("#header .headerNav .nav").text();let o=/TSADS|JBADS|老k/i.test(e);console.log("isLK",o);var e=$("<div>",{id:"buttonContainer"}).css({position:"fixed",top:"115px",right:"0",display:"none",flexWrap:"wrap",gap:"2px 5px",zIndex:1}),t=(e,t,a,n=!1)=>!(!o&&!n)&&$("<button>",{text:e,class:t,click:a}).css({padding:"6px 10px",backgroundColor:"#007bff",color:"#fff",border:"none",borderRadius:"2px",cursor:"pointer",fontSize:"12px",whiteSpace:"nowrap",flex:1}),t=[t("同步到库","cbtn",()=>a(),!1),t("按上级统计","cbtn",()=>n(),!1),t("按帖子统计","cbtn",()=>i(),!1)];e.append(...t),$("body").append(e)})();let y=a=>new Promise((t,e)=>{$.get(a,e=>{e=(new DOMParser).parseFromString(e,"text/html");t($(e))}).fail(e=>{t(!1)})}),a=async()=>{console.log("准备同步到数据库");let l=[];var e=$(".navTab-tab .selected").attr("tabid");if(!h.includes(e))return!1;let t=null;$(".navTab-panel .page").each(function(){"block"===$(this).css("display")&&(t=$(this))});e=t.find(".grid .gridTbody tr");if(!e.length)return!1;e.each(async(e,t)=>{var a=$(t),n=$(t)?.children(),t=$(t).find('a[title="用户查看"]').attr("href"),t=window.location.origin+"/"+t,o=n?.eq(1)?.children()?.eq(0)?.text(),i=n?.eq(2)?.text(),r=n?.eq(3)?.text(),d=n?.eq(4)?.text()||"-",n=n?.eq(7)?.text();l.push({uinfoUrl:t,tgnameText:r,uname:o,ucode:i,upcode:d,upname:"",amount:n,_this:a})});let a=[],n=(l?.map(e=>a.push({platform:m,ucode:e.ucode})),[]);l.map(async e=>{200<+e.amount&&e?.tgnameText?.length&&n.push({"昵称":e.uname,"用户名":e.tgnameText,"充值":e.amount})}),console.log(n);var o=await f("/user/batch",{users:a});for(let t of l){var i=o.find(e=>e.ucode===t.ucode);if(o?.length&&i)t.ads=i.ads||"",t.createDate=i.createDate||"",t.tgcode=i.tgcode||"",t.tgname=i.tgname||"",t.upname=i.upname||"",t.platform=i.platform||m;else{t.platform=m;var r,i=await(async e=>{let t=new URLSearchParams;t.append("ucode",e),t.append("type","4");["zdlucode","uname","upucode","scztimes","ecztimes","ads","status","starttime","endtime","loginstarttime","loginendtime"].forEach(e=>t.append(e,""));e=await(await fetch(window.location.origin+"/cpuser",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:t.toString(),credentials:"include"})).text(),e=(new DOMParser).parseFromString(e,"text/html");return 0===e.querySelectorAll(".pageContent .table tbody tr").length?"":{uname:e.querySelector(".pageContent .table tbody tr:nth-child(1) td:nth-child(2)")?.textContent.trim()}})(t.upcode),i=(t.upname=i?.uname||"",await y(t.uinfoUrl));for(r of $(i).find(".pageFormContent dl").toArray()){var d=$(r),c=d.find("dt")?.text(),s=d.find("dd input")?.val();if(c?.includes("注册时间"))t.createDate=s?.trim()||"";else if(c?.includes("机器人id"))t.tgcode=g(s?.trim()||"");else if(c?.includes("飞机@编码"))t.tgname=g(s?.trim()||"");else if(c?.includes("ads")){s=d.find("dd")?.text()?.trim();if(s?.length)t.ads=s;else{var p,c=await y(window.location.origin+"/cpuser/view?ucode="+t.upcode);for(p of $(c).find(".pageFormContent dl").toArray()){var u=$(p);if((u.find("dt")?.text())?.includes("ads")){u=u.find("dd")?.text()?.trim();u?.length?t.ads=u:t.ads="ADS-"+t.upcode;break}}}}}}1===t._this.children()?.eq(1)?.children()?.length&&t.ads?.length&&t._this.children().eq(1).append(`<div class="ads">${t.ads?.replace(/ads-/gi,"")}</div>`),delete t._this,delete t.uinfoUrl}l=l.filter(e=>e.ads?.length),await f("/user/sync",{users:l})},n=async()=>{var e,t=await r("/user/upcode"),a=(console.log("按上级统计数据",t?.data),[]);for(e of t.data)if(4e3<e.users?.length)for(var n of e.users){var o=d(n.tgcode),i=d(n.tgname);a.push({...n,tgcode:o,tgname:i})}console.log("users",a)},i=async()=>{var e=await r("/user/getAdsStatis");console.log("按上级统计数据",e?.data)};let l=async e=>{var t=Date.now(),e=window.location.origin+`/cpuser/cpuservisit?ucode2=${e}&_=`+t,t=await(await fetch(e)).text(),e=(new DOMParser).parseFromString(t,"text/html")?.querySelectorAll?.(".pageContent .table tbody tr");if(0===e.length)return[];let a=[];return e.forEach(e=>{e=e.querySelectorAll("td");6<=e.length&&a.push({uname:e[1].innerText.trim(),ucode:e[2].innerText.trim(),pcode:e[4].innerText.trim()})}),a}})();